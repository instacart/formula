
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.15">
    
    
      
        <title>Formula Android - Formula</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.c382b1dc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cc9b2e1e.min.css">
        
          
          
          <meta name="theme-color" content="#4cae4f">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/app.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="green" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#formula-android" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Formula" class="md-header__button md-logo" aria-label="Formula" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Formula
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Formula Android
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/instacart/formula" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Formula
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Formula" class="md-nav__button md-logo" aria-label="Formula" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Formula
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/instacart/formula" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Formula
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../events/" class="md-nav__link">
        Event Handling
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../async_events/" class="md-nav__link">
        Asynchronous Events
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../input/" class="md-nav__link">
        Using Input
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../composition/" class="md-nav__link">
        Composition
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Declarative-API/" class="md-nav__link">
        Declarative API
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Formula Android
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Formula Android
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#formula-android" class="md-nav__link">
    Formula Android
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-fragments" class="md-nav__link">
    Using Fragments
  </a>
  
    <nav class="md-nav" aria-label="Using Fragments">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#define-a-fragment-key" class="md-nav__link">
    Define a fragment key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-a-feature-factory" class="md-nav__link">
    Define a feature factory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-formula-fragment" class="md-nav__link">
    Use formula fragment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#and-thats-it" class="md-nav__link">
    And that's it
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#passing-arguments-to-a-fragment" class="md-nav__link">
    Passing arguments to a fragment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fragment-event-handling" class="md-nav__link">
    Fragment Event Handling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-back-button-events" class="md-nav__link">
    Handling back button events
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fragment-flow-factory" class="md-nav__link">
    Fragment flow factory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#activity-state-management" class="md-nav__link">
    Activity state management
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#managing-dependencies" class="md-nav__link">
    Managing dependencies
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../using_android_view_model/" class="md-nav__link">
        Using Android View Model
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../CONTRIBUTING/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#formula-android" class="md-nav__link">
    Formula Android
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-fragments" class="md-nav__link">
    Using Fragments
  </a>
  
    <nav class="md-nav" aria-label="Using Fragments">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#define-a-fragment-key" class="md-nav__link">
    Define a fragment key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-a-feature-factory" class="md-nav__link">
    Define a feature factory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-formula-fragment" class="md-nav__link">
    Use formula fragment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#and-thats-it" class="md-nav__link">
    And that's it
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#passing-arguments-to-a-fragment" class="md-nav__link">
    Passing arguments to a fragment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fragment-event-handling" class="md-nav__link">
    Fragment Event Handling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-back-button-events" class="md-nav__link">
    Handling back button events
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fragment-flow-factory" class="md-nav__link">
    Fragment flow factory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#activity-state-management" class="md-nav__link">
    Activity state management
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#managing-dependencies" class="md-nav__link">
    Managing dependencies
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/instacart/formula/edit/master/docs/Formula-Android.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>Formula Android</h1>

<h2 id="formula-android">Formula Android</h2>
<p>The Android module provides a declarative API to connect reactive state management to Android Fragments. 
This module has been designed for gradual adoption. You can use as much or as little of it as you like.</p>
<p>Some of the goals for this module are:</p>
<div class="highlight"><pre><span></span><code>- Use a single RxJava stream to drive the UI.
- Separate state management from Android UI lifecycle.
- Ability to group multiple fragments into a flow and share state between them.
- Type-safe and scoped fragment event handling. (Avoid casting activity to a listener)
</code></pre></div>
<h2 id="using-fragments">Using Fragments</h2>
<p>This module provides an API to connect state management and view rendering logic to Android 
fragments. For this example, we will connect <code>CounterRenderView</code> and <code>CounterFormula</code> from the 
main getting started <a href="..">guide</a>. </p>
<h3 id="define-a-fragment-key">Define a fragment key</h3>
<p>Fragment key is used to instantiate <code>FormulaFragment</code> and to identify which <code>FeatureFactory</code> to 
use. You can also use it to add arguments that the fragment instance needs. </p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Fragment key has to provide Parcelable implementation because it is passed </span>
<span class="cm"> * to the fragment as an argument. </span>
<span class="cm"> *   </span>
<span class="cm"> * Read more about Parcelize: https://kotlinlang.org/docs/tutorials/android-plugin.html</span>
<span class="cm"> */</span><span class="w"></span>
<span class="nd">@Parcelize</span><span class="w"></span>
<span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">CounterKey</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">tag</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;counter&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">FragmentKey</span><span class="w"></span>
</code></pre></div>
<h3 id="define-a-feature-factory">Define a feature factory</h3>
<p>A feature factory creates the state observable and a view factory for a fragment. To continue our 
example, we define a <code>CounterFeatureFactory</code> which will handle <code>CounterKey</code> fragments.</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">CounterFeatureFactory</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">FeatureFactory</span><span class="o">&lt;</span><span class="kt">Any</span><span class="p">,</span><span class="w"> </span><span class="n">CounterKey</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">dependencies</span><span class="p">:</span><span class="w"> </span><span class="kt">Any</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">CounterKey</span><span class="p">):</span><span class="w"> </span><span class="n">Feature</span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">counterFormula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CounterFormula</span><span class="p">()</span><span class="w">        </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Feature</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counterFormula</span><span class="p">.</span><span class="na">toObservable</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">viewFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CounterViewFactory</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w">   </span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// View factory which uses XML layout resource.</span><span class="w"></span>
<span class="kd">class</span><span class="w"> </span><span class="nc">CounterViewFactory</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">LayoutViewFactory</span><span class="o">&lt;</span><span class="n">CounterRenderModel</span><span class="o">&gt;</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">layout</span><span class="p">.</span><span class="na">counter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="n">ViewInstance</span><span class="p">.</span><span class="nf">create</span><span class="p">():</span><span class="w"> </span><span class="n">FeatureView</span><span class="o">&lt;</span><span class="n">CounterRenderModel</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// We use [ViewInstance.view] to access the inflated view</span><span class="w"></span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">counterView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CounterRenderView</span><span class="p">(</span><span class="n">view</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1">// We create a [FeatureView] by passing a [RenderView]</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">featureView</span><span class="p">(</span><span class="n">counterView</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>We now need to register our feature factory with the activity in which the counter will be shown.
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">MyApp</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Application</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">FormulaAndroid</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">activity</span><span class="p">(</span><span class="n">MyActivity</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">store</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">bind</span><span class="p">(</span><span class="n">CounterFeatureFactory</span><span class="p">())</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<h3 id="use-formula-fragment">Use formula fragment</h3>
<p>The only thing left is navigating to this screen. We create <code>FormulaFragment</code> instance using
our <code>CounterKey</code> and use fragment transactions to add it.
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">MyActivity</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">FormulaAppCompatActivity</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span><span class="w"> </span><span class="n">Bundle?)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">layout</span><span class="p">.</span><span class="na">my_activity</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">savedInstanceState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CounterKey</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">fragment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FormulaFragment</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="c1">// Add the fragment using the fragment transaction API.</span><span class="w"></span>
<span class="w">            </span><span class="n">supportFragmentManager</span><span class="p">.</span><span class="na">beginTransaction</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">activity_content</span><span class="p">,</span><span class="w"> </span><span class="n">fragment</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">tag</span><span class="p">)</span><span class="w">            </span>
<span class="w">                </span><span class="p">.</span><span class="na">commit</span><span class="p">()</span><span class="w">    </span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>If your <code>Activity</code> has another base class, you can just copy logic from <code>FormulaAppCompatActivity</code> into your <code>Activity</code>.</p>
<h3 id="and-thats-it">And that's it</h3>
<p>Formula takes care of the rest. This is how the state observable works:</p>
<ul>
<li>When <code>FormulaFragment</code> is added, we instantiate and subscribe to the state observable.</li>
<li>When <code>FormulaFragment</code> is removed, we destroy the state observable.</li>
</ul>
<p>The state management observable continues to run during configuration changes or if you navigate
to another fragment.</p>
<h2 id="passing-arguments-to-a-fragment">Passing arguments to a fragment</h2>
<p>Arguments can be passed using fragment key class. For example, we want to pass initial count 
value to the <code>CounterFormula</code> used in the previous examples. To accomplish that, let's update the
<code>CounterKey</code>.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Parcelize</span><span class="w"></span>
<span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">CounterKey</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">initialCount</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w">    </span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">tag</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;counter&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">FragmentKey</span><span class="w"></span>
</code></pre></div>
<p>You can access the <code>CounterKey</code> within <code>CounterFeatureFactory</code>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">CounterFeatureFactory</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">FeatureFactory</span><span class="o">&lt;</span><span class="kt">Any</span><span class="p">,</span><span class="w"> </span><span class="n">CounterKey</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">dependencies</span><span class="p">:</span><span class="w"> </span><span class="kt">Any</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">CounterKey</span><span class="p">):</span><span class="w"> </span><span class="n">Feature</span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">initialCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">initialCount</span><span class="w">    </span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">counterFormula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CounterFormula</span><span class="p">(</span><span class="n">initialCount</span><span class="p">)</span><span class="w">        </span>
<span class="w">        </span><span class="p">...</span><span class="w">                </span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<h2 id="fragment-event-handling">Fragment Event Handling</h2>
<p>Very frequently we need to pass events from a fragment to the parent/activity which trigger 
things like navigation.</p>
<p>Let's say we want to add the following behaviors to the previous counter example:</p>
<ul>
<li>show a toast notification when user increments to 10 </li>
<li>navigate to a new "victory" screen when user increments to 100. </li>
</ul>
<p>First, let's define a class that defines our events.
<div class="highlight"><pre><span></span><code><span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">CounterEventRouter</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nv">onToastNotification</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="kt">String</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nv">onVictoryReached</span><span class="p">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div></p>
<p>We can now request this dependency within our feature factory 
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">CounterFeatureFactory</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">FeatureFactory</span><span class="o">&lt;</span><span class="n">Dependencies</span><span class="p">,</span><span class="w"> </span><span class="n">CounterKey</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="c1">// We can ask for dependencies from the parent using an interface.</span><span class="w"></span>
<span class="w">    </span><span class="kd">interface</span><span class="w"> </span><span class="nc">Dependencies</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">fun</span><span class="w"> </span><span class="nf">counterEventRouter</span><span class="p">():</span><span class="w"> </span><span class="n">CounterEventRouter</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">dependencies</span><span class="p">:</span><span class="w"> </span><span class="n">Dependencies</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">CounterKey</span><span class="p">):</span><span class="w"> </span><span class="n">Feature</span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">counterEventRouter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dependencies</span><span class="p">.</span><span class="na">counterEventRouter</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="c1">// We can pass the event router to the counter formula.</span><span class="w"></span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">counterFormula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CounterFormula</span><span class="p">(</span><span class="n">counterEventRouter</span><span class="p">)</span><span class="w">        </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>To provide dependencies, the parent component needs to extend <code>CounterFeatureFactory.Dependencies</code>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">MyActivityComponent</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">store</span><span class="p">:</span><span class="w"> </span><span class="n">ActivityStoreContext</span><span class="o">&lt;</span><span class="n">MyActivity</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">CounterFeatureFactory</span><span class="p">.</span><span class="na">Dependencies</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>

<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">counterEventRouter</span><span class="p">():</span><span class="w"> </span><span class="n">CounterEventRouter</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CounterEventRouter</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">onToastNotification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">::</span><span class="n">showToast</span><span class="p">,</span><span class="w">    </span>
<span class="w">            </span><span class="n">onVictoryReached</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// VictoryFragmentKey implementation is left to readers imagination.</span><span class="w"></span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VictoryFragmentKey</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="n">navigateTo</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">showToast</span><span class="p">(</span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">store</span><span class="p">.</span><span class="na">send</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Toast</span><span class="p">.</span><span class="na">makeText</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">Toast</span><span class="p">.</span><span class="na">LENGTH_LONG</span><span class="p">).</span><span class="na">show</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w">    </span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">navigateTo</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">FragmentKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="n">store</span><span class="p">.</span><span class="na">send</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">           </span><span class="c1">// Sample fragment transaction </span><span class="w"></span>
<span class="w">           </span><span class="kd">val</span><span class="w"> </span><span class="nv">fragment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FormulaFragment</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="n">supportFragmentManager</span><span class="p">.</span><span class="na">beginTransaction</span><span class="p">()</span><span class="w"></span>
<span class="w">               </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">activity_content</span><span class="p">,</span><span class="w"> </span><span class="n">fragment</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">tag</span><span class="p">)</span><span class="w"></span>
<span class="w">               </span><span class="p">.</span><span class="na">addToBackStack</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span><span class="w"></span>
<span class="w">               </span><span class="p">.</span><span class="na">commit</span><span class="p">()</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">    </span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>To pass this component to feature factories, we need to update the configuration that lives 
within our <code>Application</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">MyApp</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Application</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">FormulaAndroid</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">activity</span><span class="p">(</span><span class="n">MyActivity</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">store</span><span class="p">(</span><span class="n">MyActivityComponent</span><span class="p">(</span><span class="k">this</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">bind</span><span class="p">(</span><span class="n">CounterFeatureFactory</span><span class="p">())</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h2 id="handling-back-button-events">Handling back button events</h2>
<p>To override how the back button works for a particular navigation destination, your render model needs to implement
<code>BackCallback</code> interface.</p>
<div class="highlight"><pre><span></span><code><span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">FormRenderModel</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">confirmBeforeExiting</span><span class="p">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">confirmUserWantsToExit</span><span class="p">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span><span class="w"></span>
<span class="p">):</span><span class="w"> </span><span class="n">BackCallback</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onBackPressed</span><span class="p">():</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Check if we need to override back handling</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">confirmBeforeExiting</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">confirmUserWantsToExit</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Use default behavior (which closes the screen)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Your <code>Activity</code> needs to call <code>FormulaAndroid.onBackPressed()</code>. It will check if your current screen
implements <code>BackCallback</code> and will invoke it.
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">MyActivity</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">FragmentActivity</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">     </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onBackPressed</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">FormulaAndroid</span><span class="p">.</span><span class="na">onBackPressed</span><span class="p">(</span><span class="k">this</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">             </span><span class="k">super</span><span class="p">.</span><span class="na">onBackPressed</span><span class="p">()</span><span class="w"></span>
<span class="w">         </span><span class="p">}</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
This is already in place for you if you use <code>FormulaAppCompatActivity</code>.</p>
<h2 id="fragment-flow-factory">Fragment flow factory</h2>
<p>A flow factory groups multiple fragments and allows to share state, routers, action handlers
and other dependencies between them. It has two generic parameters:</p>
<ul>
<li><code>Dependencies</code> that the parent needs to provide. </li>
<li><code>FlowComponent</code> that will be shared with all features defined by this flow.</li>
</ul>
<p>For this example, let's say we are building authentication for our app. The backend provides view
information such as the hints we should show for email or password fields. We want to only fetch 
this data once and share it between the login and sign up fragments. Let's say our repository 
class looks something like this</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">AuthRepo</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">retrofit</span><span class="p">:</span><span class="w"> </span><span class="n">Retrofit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Backend provides data that helps us render auth pages.</span><span class="w"></span>
<span class="w">    </span><span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">PageResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">emailHint</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">passwordHint</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">// This will check if we have in-memory response and</span><span class="w"></span>
<span class="w">    </span><span class="c1">// return that, otherwise make a fresh call.</span><span class="w"></span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">pageEvents</span><span class="p">():</span><span class="w"> </span><span class="n">Observable</span><span class="o">&lt;</span><span class="n">AuthPageResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>As you can see above, this repository class needs a <code>Retrofit</code> instance to function. We can define
the dependencies we need using an interface.
<div class="highlight"><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nc">Dependencies</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">retrofit</span><span class="p">():</span><span class="w"> </span><span class="n">Retrofit</span><span class="w">    </span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>Let's create our flow component. In a real application, component would usually be implemented by DI framework such as <code>Dagger</code>.
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">AuthFlowComponent</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">dependencies</span><span class="p">:</span><span class="w"> </span><span class="n">Dependencies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Auth repo needs to be a singleton so we instantiate </span><span class="w"></span>
<span class="w">    </span><span class="c1">// this once when component is created.</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">authRepo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AuthRepo</span><span class="p">(</span><span class="n">dependencies</span><span class="p">.</span><span class="na">retrofit</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>We can now define <code>AuthFlowFactory</code>. A flow factory has two methods:</p>
<ul>
<li><code>createComponent</code> - we create <code>AuthFlowComponent</code> here</li>
<li><code>createFlow</code> - we register feature factories that are part of our flow</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">AuthFlowFactory</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">FlowFactory</span><span class="o">&lt;</span><span class="n">Dependencies</span><span class="p">,</span><span class="w"> </span><span class="n">AuthFlowComponent</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">interface</span><span class="w"> </span><span class="nc">Dependencies</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">fun</span><span class="w"> </span><span class="nf">retrofit</span><span class="p">():</span><span class="w"> </span><span class="n">Retrofit</span><span class="w">    </span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">class</span><span class="w"> </span><span class="nc">AuthFlowComponent</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">dependencies</span><span class="p">:</span><span class="w"> </span><span class="n">Dependencies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">authRepo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AuthRepo</span><span class="p">(</span><span class="n">dependencies</span><span class="p">.</span><span class="na">retrofit</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">createComponent</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">dependencies</span><span class="p">:</span><span class="w"> </span><span class="n">Dependencies</span><span class="w"></span>
<span class="w">    </span><span class="p">):</span><span class="w"> </span><span class="n">DisposableScope</span><span class="o">&lt;</span><span class="n">AuthFlowComponent</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">flowComponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AuthFlowComponent</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DisposableScope</span><span class="p">(</span><span class="n">flowComponent</span><span class="p">,</span><span class="w"> </span><span class="n">onDispose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// Here you can clear observables and dispose of other resources </span><span class="w"></span>
<span class="w">            </span><span class="c1">// that the component needed</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">createFlow</span><span class="p">():</span><span class="w"> </span><span class="n">Flow</span><span class="o">&lt;</span><span class="n">AuthFlowComponent</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Flow</span><span class="p">.</span><span class="na">build</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">bind</span><span class="p">(</span><span class="n">AuthRootFeatureFactory</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">bind</span><span class="p">(</span><span class="n">LoginFeatureFactory</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">bind</span><span class="p">(</span><span class="n">SignUpFeatureFactory</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Before we integrate <code>AuthFlowFactory</code> within our application, we need to update our app component
to provide dependencies.</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">AppComponent</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">AuthFlowFactory</span><span class="p">.</span><span class="na">Dependencies</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">retrofit</span><span class="p">():</span><span class="w"> </span><span class="n">Retrofit</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Now that we have our dependencies configured, let's bind the flow factory to our activity store
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">appComponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppComponent</span><span class="p">()</span><span class="w"></span>
<span class="n">FormulaAndroid</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">activity</span><span class="p">(</span><span class="n">MyActivity</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">store</span><span class="p">(</span><span class="n">appComponent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">bind</span><span class="p">(</span><span class="n">AuthFlowFactory</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>Formula calls <code>createComponent</code> when a formula fragment handled by <code>createFlow</code> is added. This 
component lives as long as there are any formula fragments defined by <code>createFlow</code> alive. The 
component is disposed once the last formula fragment is removed.     </p>
<h2 id="activity-state-management">Activity state management</h2>
<p>One of the goals of Formula is to make doing the right thing easy. As part of that we wanted to provide an easy
way for state streams to survive configuration changes by default. </p>
<p>Let's define a basic activity that has a <code>renderTime</code> method.
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">MyActivity</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">FormulaAppCompatActivity</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">renderTime</span><span class="p">(</span><span class="n">time</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// implementation left to the reader</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>To connect an RxJava Observable to <code>renderTime</code>, we define <code>streams</code> parameter which expects a <code>Disposable</code>
back. Within this method you can subscribe to any number of RxJava streams.  <br />
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">MyApp</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Application</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">FormulaAndroid</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">activity</span><span class="o">&lt;</span><span class="n">MyActivity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                </span><span class="n">store</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">streams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="c1">// You can subscribe to your RxJava streams here.</span><span class="w"></span>
<span class="w">                        </span><span class="kd">val</span><span class="w"> </span><span class="nv">timerState</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">Observable</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="na">interval</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="na">observeOn</span><span class="p">(</span><span class="n">AndroidSchedulers</span><span class="p">.</span><span class="na">mainThread</span><span class="p">())</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="na">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"></span>
<span class="w">                                </span><span class="s">&quot;</span><span class="si">$</span><span class="n">time</span><span class="s"> seconds&quot;</span><span class="w"></span>
<span class="w">                            </span><span class="p">}</span><span class="w"></span>

<span class="w">                        </span><span class="c1">// update ensures that if configuration changes happen then</span><span class="w"></span>
<span class="w">                        </span><span class="c1">// we send the last state to the new activity instance.    </span><span class="w"></span>
<span class="w">                        </span><span class="n">update</span><span class="p">(</span><span class="n">timerState</span><span class="p">,</span><span class="w"> </span><span class="n">MyActivity</span><span class="o">::</span><span class="n">renderTime</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>You might be confused about the <code>update</code> function called there. It is provided within the context of <code>streams</code> function
using Kotlin receiver parameter <code>StreamConfigurator</code>. The <code>update</code> function ensures that state changes only arrive after
<code>Activity</code> has started and that last state is applied if <code>Activity</code> is re-created due to configuration changes. It returns
a <code>Disposable</code>.</p>
<h2 id="managing-dependencies">Managing dependencies</h2>
<p>Managing dependencies in Formula is very easy. In the function that instantiates the <code>ActivityStore</code> for your activity, 
you can create your activity specific dependencies or Dagger components. These objects will survive configuration changes.
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">MyApp</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Application</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">appComponent</span><span class="p">:</span><span class="w"> </span><span class="n">AppComponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"></span>

<span class="w">        </span><span class="n">FormulaAndroid</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">activity</span><span class="p">(</span><span class="n">MyActivity</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// This component will survive configuration changes.</span><span class="w"></span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityComponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appComponent</span><span class="p">.</span><span class="na">createMyActivityComponent</span><span class="p">()</span><span class="w"></span>

<span class="w">                </span><span class="n">store</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>To inject the activity or create activity dependencies that don't survive configuration changes such as ones that need direct
activity reference, you can use <code>configureActivity</code> callback.
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">appComponent</span><span class="p">:</span><span class="w"> </span><span class="n">AppComponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"></span>

<span class="n">FormulaAndroid</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">activity</span><span class="p">(</span><span class="n">MyActivity</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// This component will survive configuration changes.</span><span class="w"></span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityComponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appComponent</span><span class="p">.</span><span class="na">createMyActivityComponent</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">store</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">configureActivity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// in this callback `this` is the instance of MyActivity</span><span class="w"></span>
<span class="w">                </span><span class="c1">// so we can use it to inject dependencies</span><span class="w"></span>
<span class="w">                </span><span class="n">activityComponent</span><span class="p">.</span><span class="na">inject</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="c1">// Or you can use setters to provide dependencies to your activity.</span><span class="w"></span>
<span class="w">                </span><span class="c1">// This dependency object won&#39;t survive configuration changes.</span><span class="w"></span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">dependency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyActivityDependency</span><span class="p">(</span><span class="n">activity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="na">setDependency</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../Declarative-API/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Declarative API" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Declarative API
            </div>
          </div>
        </a>
      
      
        
        <a href="../using_android_view_model/" class="md-footer__link md-footer__link--next" aria-label="Next: Using Android View Model" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Using Android View Model
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.a6c66575.min.js"></script>
      
    
  </body>
</html>