



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Formula Android - Formula</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.0284f74d.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.01803549.css">
      
      
        
        
        <meta name="theme-color" content="#4caf50">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../css/app.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="green" data-md-color-accent="">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#formula-android" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Formula" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Formula
            </span>
            <span class="md-header-nav__topic">
              
                Formula Android
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/instacart/formula/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Formula
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Formula" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Formula
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/instacart/formula/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Formula
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../events/" title="Event Handling" class="md-nav__link">
      Event Handling
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../async_events/" title="Asynchronous Events" class="md-nav__link">
      Asynchronous Events
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../input/" title="Using Input" class="md-nav__link">
      Using Input
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../composition/" title="Composition" class="md-nav__link">
      Composition
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../testing/" title="Testing" class="md-nav__link">
      Testing
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Formula Android
      </label>
    
    <a href="./" title="Formula Android" class="md-nav__link md-nav__link--active">
      Formula Android
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#formula-android" title="Formula Android" class="md-nav__link">
    Formula Android
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" title="Getting Started" class="md-nav__link">
    Getting Started
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-the-render-model" title="Defining the render model" class="md-nav__link">
    Defining the render model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lets-apply-this-render-model-to-android-views" title="Let's apply this render model to android views" class="md-nav__link">
    Let's apply this render model to android views
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#register-state-management-for-this-screen" title="Register state management for this screen" class="md-nav__link">
    Register state management for this screen
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-only-thing-left-is-navigating-to-this-screen" title="The only thing left is navigating to this screen" class="md-nav__link">
    The only thing left is navigating to this screen
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#and-thats-it" title="And that's it" class="md-nav__link">
    And that's it
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-pass-arguments-such-as-item-id-to-the-fragment" title="How to pass arguments such as item id to the fragment?" class="md-nav__link">
    How to pass arguments such as item id to the fragment?
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fragment-event-handling" title="Fragment Event Handling" class="md-nav__link">
    Fragment Event Handling
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#navigation" title="Navigation" class="md-nav__link">
    Navigation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grouping-multiple-navigation-destinations-as-part-of-a-flow" title="Grouping multiple navigation destinations as part of a flow." class="md-nav__link">
    Grouping multiple navigation destinations as part of a flow.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#moving-integration-into-a-separate-class" title="Moving integration into a separate class" class="md-nav__link">
    Moving integration into a separate class
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-back-button-events" title="Handling back button events" class="md-nav__link">
    Handling back button events
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#activity-state-management" title="Activity state management" class="md-nav__link">
    Activity state management
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#managing-dependencies" title="Managing dependencies" class="md-nav__link">
    Managing dependencies
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../using_android_view_model/" title="Using Android View Model" class="md-nav__link">
      Using Android View Model
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contributing/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#formula-android" title="Formula Android" class="md-nav__link">
    Formula Android
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" title="Getting Started" class="md-nav__link">
    Getting Started
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-the-render-model" title="Defining the render model" class="md-nav__link">
    Defining the render model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lets-apply-this-render-model-to-android-views" title="Let's apply this render model to android views" class="md-nav__link">
    Let's apply this render model to android views
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#register-state-management-for-this-screen" title="Register state management for this screen" class="md-nav__link">
    Register state management for this screen
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-only-thing-left-is-navigating-to-this-screen" title="The only thing left is navigating to this screen" class="md-nav__link">
    The only thing left is navigating to this screen
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#and-thats-it" title="And that's it" class="md-nav__link">
    And that's it
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-pass-arguments-such-as-item-id-to-the-fragment" title="How to pass arguments such as item id to the fragment?" class="md-nav__link">
    How to pass arguments such as item id to the fragment?
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fragment-event-handling" title="Fragment Event Handling" class="md-nav__link">
    Fragment Event Handling
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#navigation" title="Navigation" class="md-nav__link">
    Navigation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grouping-multiple-navigation-destinations-as-part-of-a-flow" title="Grouping multiple navigation destinations as part of a flow." class="md-nav__link">
    Grouping multiple navigation destinations as part of a flow.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#moving-integration-into-a-separate-class" title="Moving integration into a separate class" class="md-nav__link">
    Moving integration into a separate class
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-back-button-events" title="Handling back button events" class="md-nav__link">
    Handling back button events
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#activity-state-management" title="Activity state management" class="md-nav__link">
    Activity state management
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#managing-dependencies" title="Managing dependencies" class="md-nav__link">
    Managing dependencies
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/instacart/formula/edit/master/docs/Integration.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Formula Android</h1>
                
                <h2 id="formula-android">Formula Android</h2>
<p>The Android module provides a declarative API to connect reactive state management to Android Fragments. 
This module has been designed for gradual adoption. You can use as much or as little of it as you like.</p>
<p>Some of the goals for this module are:
- Use single RxJava stream to drive the UI.
- Separate state management from Android UI lifecycle.
- Ability to group multiple fragments into a flow and share state between them.
- Type-safe and scoped fragment event handling. (Avoid casting activity to a listener)</p>
<h2 id="getting-started">Getting Started</h2>
<p>For the getting started guide, we will build a timer which you can reset. This is a simple example, but 
it will be sufficient to display some of the concepts around this module.</p>
<h3 id="defining-the-render-model">Defining the render model</h3>
<p>When working with Formula, usually the first thing we define is what our UI will be rendering and what actions it will
perform. Render Model is a class that defines this.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">TimerRenderModel</span><span class="p">(</span>
    <span class="k">val</span> <span class="py">time</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
    <span class="k">val</span> <span class="py">onResetSelected</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
<span class="p">)</span>
</pre></div>


<h3 id="lets-apply-this-render-model-to-android-views">Let's apply this render model to android views</h3>
<p>We define a fragment contract for how a render model is applied to Android views.</p>
<div class="codehilite"><pre><span></span><span class="c1">// Fragment contract has to provide Parcelable implementation because it is passed to the fragment as an argument.</span>
<span class="c1">// Read more about Parcelize: https://kotlinlang.org/docs/tutorials/android-plugin.html</span>
<span class="n">@Parcelize</span>
<span class="k">data</span> <span class="k">class</span> <span class="nc">TimerContract</span><span class="p">(</span>
    <span class="k">override</span> <span class="k">val</span> <span class="py">tag</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="s">&quot;timer&quot;</span><span class="p">,</span>
    <span class="k">override</span> <span class="k">val</span> <span class="py">layoutId</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="n">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">timer</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">FragmentContract</span><span class="p">&lt;</span><span class="n">TimerRenderModel</span><span class="p">&gt;()</span> <span class="p">{</span>

    <span class="c1">// A layout is automatically inflated and the view is passed to this callback.</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">createComponent</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="n">View</span><span class="p">):</span> <span class="n">FragmentComponent</span><span class="p">&lt;</span><span class="n">TimerRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">val</span> <span class="py">timerTextView</span> <span class="p">=</span> <span class="n">view</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">timer_text_view</span><span class="p">)</span>
        <span class="k">val</span> <span class="py">resetButton</span> <span class="p">=</span> <span class="n">view</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">timer_reset_button</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">FragmentComponent</span><span class="p">.</span><span class="n">create</span> <span class="p">{</span> <span class="n">renderModel</span> <span class="p">-&gt;</span>
            <span class="n">timerTextView</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">renderModel</span><span class="p">.</span><span class="n">time</span>
            <span class="n">resetButton</span><span class="p">.</span><span class="n">setOnClickListener</span> <span class="p">{</span>
                <span class="n">renderModel</span><span class="p">.</span><span class="n">onResetSelected</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="register-state-management-for-this-screen">Register state management for this screen</h3>
<p>Fragment contract is used as a navigation destination key. For each of the fragment contract types, we provide 
a state management factory. This factory has to return an <code>Observable&lt;RenderModel&gt;</code>. The factory will be invoked
when the user enters this destination.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyApp</span> <span class="p">:</span> <span class="n">Application</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">()</span>

        <span class="n">FormulaAndroid</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">activity</span><span class="p">(</span><span class="n">MyActivity</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">store</span> <span class="p">{</span>
                    <span class="c1">// Bind function provides type safety - given a TimerContract,</span>
                    <span class="c1">// it expects Observable&lt;TimerRenderModel&gt; from the factory</span>
                    <span class="n">bind</span><span class="p">(</span><span class="n">TimerContract</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">contract</span> <span class="p">-&gt;</span>
                        <span class="k">val</span> <span class="py">resetRelay</span> <span class="p">=</span> <span class="n">PublishRelay</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;()</span>

                        <span class="n">resetRelay</span><span class="p">.</span><span class="n">startWith</span><span class="p">(</span><span class="n">Unit</span><span class="p">).</span><span class="n">switchMap</span> <span class="p">{</span> 
                            <span class="n">Observable</span>
                                <span class="p">.</span><span class="n">interval</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="n">SECONDS</span><span class="p">)</span>
                                <span class="p">.</span><span class="n">observeOn</span><span class="p">(</span><span class="n">AndroidSchedulers</span><span class="p">.</span><span class="n">mainThread</span><span class="p">())</span>
                        <span class="p">}</span>
                        <span class="p">.</span><span class="n">map</span> <span class="p">{</span>
                            <span class="n">TimerRenderModel</span><span class="p">(</span>
                                <span class="n">time</span> <span class="p">=</span> <span class="s">&quot;$it seconds passed.&quot;</span><span class="p">,</span>
                                <span class="n">onResetSelected</span> <span class="p">=</span> <span class="p">{</span>
                                    <span class="n">resetRelay</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>For the sake of simplicity, I've inlined the state management logic into the <code>bind</code> function. In a real world example,
this logic would live within <code>Formula</code>.</p>
<h3 id="the-only-thing-left-is-navigating-to-this-screen">The only thing left is navigating to this screen</h3>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyActivity</span> <span class="p">:</span> <span class="n">FormulaAppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">my_activity</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">savedInstanceState</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">val</span> <span class="py">contract</span> <span class="p">=</span> <span class="n">TimerContract</span><span class="p">()</span>
            <span class="k">val</span> <span class="py">fragment</span> <span class="p">=</span> <span class="n">FormulaFragment</span><span class="p">.</span><span class="n">newInstance</span><span class="p">(</span><span class="n">contract</span><span class="p">)</span>

            <span class="c1">// Add the fragment using the fragment transaction API.</span>
            <span class="n">supportFragmentManager</span><span class="p">.</span><span class="n">beginTransaction</span><span class="p">()</span>
                <span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">activity_content</span><span class="p">,</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">contract</span><span class="p">.</span><span class="n">tag</span><span class="p">)</span>
                <span class="p">.</span><span class="n">commit</span><span class="p">()</span>    
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>If your <code>Activity</code> has another base class, you can just copy logic from <code>FormulaAppCompatActivity</code> into your <code>Activity</code>.</p>
<h3 id="and-thats-it">And that's it</h3>
<p>Formula takes care of the rest. The RxJava state stream is instantiated and subscribed to when the user enters 
declared navigation destination. We dispose of the stream only when user exits the destination. </p>
<h2 id="how-to-pass-arguments-such-as-item-id-to-the-fragment">How to pass arguments such as item id to the fragment?</h2>
<p>Arguments can be passed using the Fragment contract.</p>
<div class="codehilite"><pre><span></span><span class="n">@Parcelize</span>
<span class="k">data</span> <span class="k">class</span> <span class="nc">ItemDetailContract</span><span class="p">(</span>
    <span class="k">val</span> <span class="py">itemId</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
    <span class="k">override</span> <span class="k">val</span> <span class="py">tag</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="s">&quot;item detail ${itemId}&quot;</span><span class="p">,</span>
    <span class="k">override</span> <span class="k">val</span> <span class="py">layoutId</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="n">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">item_detail</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">FragmentContract</span><span class="p">&lt;</span><span class="n">RenderModelType</span><span class="p">&gt;()</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">createComponent</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="n">View</span><span class="p">):</span> <span class="n">FragmentComponent</span><span class="p">&lt;</span><span class="n">RenderModelType</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">TODO</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>The contract is passed to the function that instantiates the state management</p>
<div class="codehilite"><pre><span></span><span class="k">val</span> <span class="py">store</span> <span class="p">=</span> <span class="n">FragmentFlowStore</span><span class="p">.</span><span class="n">init</span> <span class="p">{</span>
    <span class="n">bind</span><span class="p">(</span><span class="n">ItemDetailContract</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">ItemDetailContract</span> <span class="p">-&gt;</span>
        <span class="c1">// do something with the item id</span>
        <span class="n">key</span><span class="p">.</span><span class="n">itemId</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="fragment-event-handling">Fragment Event Handling</h3>
<p>In fragments, a common pattern for passing events to the parent is casting Activity into a Listener</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyFragment</span> <span class="p">:</span> <span class="n">Fragment</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onAttach</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">listener</span> <span class="p">=</span> <span class="n">context</span> <span class="k">as</span> <span class="n">Listener</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onDetach</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">listener</span> <span class="p">=</span> <span class="k">null</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Instead of a listener with methods, we define a sealed class of possible actions that activity can perform.</p>
<div class="codehilite"><pre><span></span><span class="k">sealed</span> <span class="k">class</span> <span class="nc">MyActivityEffect</span> <span class="p">{</span>
    <span class="k">class</span> <span class="nc">ShowToast</span><span class="p">(</span><span class="k">val</span> <span class="py">message</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">MyActivityEffect</span><span class="p">()</span>
    <span class="k">class</span> <span class="nc">CloseFragment</span><span class="p">(</span><span class="k">val</span> <span class="py">tag</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">MyActivityEffect</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyActivity</span> <span class="p">:</span> <span class="n">FragmentActivity</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">fun</span> <span class="nf">onActivityEffect</span><span class="p">(</span><span class="n">effect</span><span class="p">:</span> <span class="n">MyActivityEffect</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">when</span> <span class="p">(</span><span class="n">effect</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">is</span> <span class="n">ShowToast</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="n">Toast</span><span class="p">.</span><span class="n">makeText</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">effect</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="n">Toast</span><span class="p">.</span><span class="n">LENGTH_LONG</span><span class="p">).</span><span class="n">show</span><span class="p">();</span>
            <span class="p">}</span> 
            <span class="k">is</span> <span class="n">CloseFragment</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="n">supportFragmentManager</span><span class="p">.</span><span class="n">popBackStack</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>We can then use a <code>ActivityProxy&lt;MyActivity&gt;</code> to trigger this effect.</p>
<div class="codehilite"><pre><span></span><span class="n">activity</span><span class="p">(</span><span class="n">MyActivity</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">store</span> <span class="p">{</span>
        <span class="n">bind</span><span class="p">(</span><span class="n">ItemDetailContract</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">contract</span> <span class="p">-&gt;</span>
            <span class="k">val</span> <span class="py">input</span> <span class="p">=</span> <span class="n">ItemDetailFormula</span><span class="p">.</span><span class="n">Input</span><span class="p">(</span>
                <span class="n">onItemFavorited</span> <span class="p">=</span> <span class="p">{</span>
                    <span class="n">send</span> <span class="p">{</span>
                        <span class="n">onActivityEffect</span><span class="p">(</span><span class="n">MyActivityEffect</span><span class="p">.</span><span class="n">ShowToast</span><span class="p">(</span><span class="s">&quot;Item was added to your favorites.&quot;</span><span class="p">))</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="n">onItemDeleted</span> <span class="p">=</span> <span class="p">{</span>
                    <span class="n">send</span> <span class="p">{</span>
                        <span class="n">onActivityEffect</span><span class="p">(</span><span class="n">MyActivityEffect</span><span class="p">.</span><span class="n">CloseFragment</span><span class="p">(</span><span class="n">contract</span><span class="p">.</span><span class="n">tag</span><span class="p">))</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="k">val</span> <span class="py">formula</span><span class="p">:</span> <span class="n">ItemDetailFormula</span> <span class="p">=</span> <span class="n">component</span><span class="p">.</span><span class="n">createItemDetailFormula</span><span class="p">()</span>
            <span class="n">formula</span><span class="p">.</span><span class="n">state</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="navigation">Navigation</h2>
<p>To trigger navigation from one screen to another, we add a new type to the <code>MyActivityEffect</code> sealed class.</p>
<div class="codehilite"><pre><span></span><span class="k">sealed</span> <span class="k">class</span> <span class="nc">MyActivityEffect</span> <span class="p">{</span>
    <span class="p">...</span> 
    <span class="k">class</span> <span class="nc">NavigateToFragmentContract</span><span class="p">(</span><span class="k">val</span> <span class="py">contract</span><span class="p">:</span> <span class="n">FragmentContract</span><span class="p">&lt;*&gt;):</span> <span class="n">MyActivityEffect</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>


<p>Now, we can trigger it from event callback such as <code>onItemSelected</code></p>
<div class="codehilite"><pre><span></span><span class="n">activity</span><span class="p">(</span><span class="n">MyActivity</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">store</span> <span class="p">{</span>
        <span class="n">bind</span><span class="p">(</span><span class="n">ItemListContract</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">contract</span> <span class="p">-&gt;</span>
            <span class="c1">// Provide callbacks to item list feature events.</span>
            <span class="k">val</span> <span class="py">input</span> <span class="p">=</span> <span class="n">ItemListFormula</span><span class="p">.</span><span class="n">Input</span><span class="p">(</span>
                <span class="n">onItemSelected</span> <span class="p">=</span> <span class="p">{</span> <span class="n">item</span> <span class="p">-&gt;</span>
                    <span class="k">val</span> <span class="py">contract</span> <span class="p">=</span> <span class="n">ItemDetailContract</span><span class="p">(</span><span class="n">id</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="n">send</span> <span class="p">{</span>
                        <span class="n">onActivityEffect</span><span class="p">(</span><span class="n">ActivityEffect</span><span class="p">.</span><span class="n">NavigateToFragmentContract</span><span class="p">(</span><span class="n">contract</span><span class="p">))</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1">// Hook up the formula state management</span>
            <span class="k">val</span> <span class="py">formula</span><span class="p">:</span> <span class="n">ItemListFormula</span> <span class="p">=</span> <span class="p">...</span>
            <span class="n">formula</span><span class="p">.</span><span class="n">state</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>In our activity, we can react to this effect and perform the navigation</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyActivity</span> <span class="p">:</span> <span class="n">FormulaAppCompatActivity</span><span class="p">()</span> <span class="p">{</span>

     <span class="k">fun</span> <span class="nf">onActivityEffect</span><span class="p">(</span><span class="n">effect</span><span class="p">:</span> <span class="n">MyActivityEffect</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">when</span><span class="p">(</span><span class="n">effect</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">is</span> <span class="n">NavigateToFragmentContract</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="c1">// Perform navigation using fragment transaction</span>
                <span class="k">val</span> <span class="py">fragment</span> <span class="p">=</span> <span class="n">FormulaFragment</span><span class="p">.</span><span class="n">newInstance</span><span class="p">(</span><span class="n">effect</span><span class="p">.</span><span class="n">contract</span><span class="p">)</span>

                <span class="n">supportFragmentManager</span><span class="p">.</span><span class="n">beginTransaction</span><span class="p">()</span>
                    <span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">fragment_container</span><span class="p">,</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">effect</span><span class="p">.</span><span class="n">contract</span><span class="p">.</span><span class="n">tag</span><span class="p">)</span>
                    <span class="p">.</span><span class="n">addToBackStack</span><span class="p">(</span><span class="k">null</span><span class="p">)</span>
                    <span class="p">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
     <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="grouping-multiple-navigation-destinations-as-part-of-a-flow">Grouping multiple navigation destinations as part of a flow.</h2>
<p>Flow is a combination of screens that are grouped together and can share a common component / state.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyFlowDeclaration</span> <span class="p">:</span> <span class="n">FlowDeclaration</span><span class="p">&lt;</span><span class="n">MyFlowDeclaration</span><span class="p">.</span><span class="n">Component</span><span class="p">&gt;()</span> <span class="p">{</span>
  <span class="c1">// Define the shared component for the flow </span>
  <span class="k">class</span> <span class="nc">Component</span><span class="p">(</span>
    <span class="k">val</span> <span class="py">sharedService</span><span class="p">:</span> <span class="n">MyFlowService</span><span class="p">,</span>
    <span class="k">val</span> <span class="py">onSomeEvent</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
  <span class="p">)</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">createFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Component</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">build</span> <span class="p">{</span>
      <span class="n">bind</span><span class="p">(</span><span class="n">Contract1</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span> <span class="n">component</span><span class="p">,</span> <span class="n">contract</span> <span class="p">-&gt;</span>
        <span class="n">TODO</span><span class="p">(</span><span class="s">&quot;return an RxJava state stream that drives the UI&quot;</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="n">bind</span><span class="p">(</span><span class="n">Contract2</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span> <span class="n">component</span><span class="p">,</span> <span class="n">contract</span> <span class="p">-&gt;</span>
        <span class="n">TODO</span><span class="p">(</span><span class="s">&quot;return an RxJava state stream that drives the UI&quot;</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span> 
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="moving-integration-into-a-separate-class">Moving integration into a separate class</h2>
<p>When you reach a certain number of fragment integrations, the store creation logic can become unwieldy. To keep it tidy,
you can place integration logic into separate class.</p>
<div class="codehilite"><pre><span></span><span class="k">object</span> <span class="nc">TaskDetailIntegration</span> <span class="p">:</span> <span class="n">Integration</span><span class="p">&lt;</span><span class="n">TaskAppComponent</span><span class="p">,</span> <span class="n">TaskDetailContract</span><span class="p">,</span> <span class="n">TaskDetailRenderModel</span><span class="p">&gt;()</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">create</span><span class="p">(</span><span class="n">component</span><span class="p">:</span> <span class="n">TaskAppComponent</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">TaskDetailContract</span><span class="p">):</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">TaskDetailRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">component</span><span class="p">.</span><span class="n">taskRepo</span><span class="p">.</span><span class="n">findTask</span><span class="p">(</span><span class="n">taskId</span><span class="p">).</span><span class="n">map</span> <span class="p">{</span> <span class="n">task</span> <span class="p">-&gt;</span>
            <span class="n">TaskDetailRenderModel</span><span class="p">(</span>
                <span class="n">description</span> <span class="p">=</span> <span class="n">task</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="n">onDeleteSelected</span> <span class="p">=</span> <span class="p">{</span>
                    <span class="n">component</span><span class="p">.</span><span class="n">taskRepo</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">taskId</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Now we can update our store to use this integration.</p>
<div class="codehilite"><pre><span></span><span class="k">val</span> <span class="py">store</span> <span class="p">=</span> <span class="n">FragmentFlowStore</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">taskAppComponent</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">bind</span><span class="p">(</span><span class="n">TaskDetailIntegration</span><span class="p">)</span>

    <span class="c1">// Other integrations.</span>
    <span class="n">bind</span><span class="p">(</span><span class="n">Contract1Integration</span><span class="p">)</span>
    <span class="n">bind</span><span class="p">(</span><span class="n">Contract2Integration</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<h2 id="handling-back-button-events">Handling back button events</h2>
<p>To override how the back button works for a particular navigation destination, your render model needs to implement
<code>BackCallback</code> interface.</p>
<div class="codehilite"><pre><span></span><span class="k">data</span> <span class="k">class</span> <span class="nc">FormRenderModel</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">confirmBeforeExiting</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">confirmUserWantsToExit</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
<span class="p">):</span> <span class="n">BackCallback</span> <span class="p">{</span>

    <span class="k">fun</span> <span class="nf">onBackPressed</span><span class="p">():</span> <span class="n">Boolean</span> <span class="p">{</span>
        <span class="c1">// Check if we need to override back handling</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">confirmBeforeExiting</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">confirmUserWantsToExit</span><span class="p">()</span>
            <span class="k">return</span> <span class="k">true</span>
        <span class="p">}</span>

        <span class="c1">// Use default behavior (which closes the screen)</span>
        <span class="k">return</span> <span class="k">false</span> 
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Your <code>Activity</code> needs to call <code>FormulaAndroid.onBackPressed()</code>. It will check if your current screen
implements <code>BackCallback</code> and will invoke it.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyActivity</span> <span class="p">:</span> <span class="n">FragmentActivity</span><span class="p">()</span> <span class="p">{</span>

     <span class="k">override</span> <span class="k">fun</span> <span class="nf">onBackPressed</span><span class="p">()</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(!</span><span class="n">FormulaAndroid</span><span class="p">.</span><span class="n">onBackPressed</span><span class="p">(</span><span class="k">this</span><span class="p">))</span> <span class="p">{</span>
             <span class="k">super</span><span class="p">.</span><span class="n">onBackPressed</span><span class="p">()</span>
         <span class="p">}</span>
     <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="activity-state-management">Activity state management</h2>
<p>One of the goals of Formula is to make doing the right thing easy. As part of that we wanted to provide an easy
way for state streams to survive configuration changes by default. </p>
<p>Let's define a basic activity that has a <code>renderTime</code> method.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyActivity</span> <span class="p">:</span> <span class="n">FormulaAppCompatActivity</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">fun</span> <span class="nf">renderTime</span><span class="p">(</span><span class="n">time</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// implementation left to the reader</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>To connect an RxJava Observable to <code>renderTime</code>, we define <code>streams</code> parameter which expects a <code>Disposable</code>
back. Within this method you can subscribe to any number of RxJava streams.    </p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyApp</span> <span class="p">:</span> <span class="n">Application</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">()</span>

        <span class="n">FormulaAndroid</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">activity</span><span class="p">&lt;</span><span class="n">MyActivity</span><span class="p">&gt;</span> <span class="p">{</span>

                <span class="n">store</span><span class="p">(</span>
                    <span class="n">streams</span> <span class="p">=</span> <span class="p">{</span>
                        <span class="c1">// You can subscribe to your RxJava streams here.</span>
                        <span class="k">val</span> <span class="py">timerState</span> <span class="p">=</span>  <span class="n">Observable</span>
                            <span class="p">.</span><span class="n">interval</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="n">SECONDS</span><span class="p">)</span>
                            <span class="p">.</span><span class="n">observeOn</span><span class="p">(</span><span class="n">AndroidSchedulers</span><span class="p">.</span><span class="n">mainThread</span><span class="p">())</span>
                            <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">time</span> <span class="p">-&gt;</span>
                                <span class="s">&quot;$time seconds&quot;</span>
                            <span class="p">}</span>

                        <span class="c1">// update ensures that if configuration changes happen that</span>
                        <span class="c1">// we send the last state to the new activity instance.    </span>
                        <span class="n">update</span><span class="p">(</span><span class="n">timerState</span><span class="p">,</span> <span class="n">MyActivity</span><span class="o">::</span><span class="n">renderTime</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>You might be confused about the <code>update</code> function called there. It is provided within the context of <code>streams</code> function
using Kotlin receiver parameter <code>StreamConfigurator</code>. The <code>update</code> function ensures that state changes only arrive after
<code>Activity</code> has started and that last state is applied if <code>Activity</code> is re-created due to configuration changes. It returns
a <code>Disposable</code>.</p>
<h2 id="managing-dependencies">Managing dependencies</h2>
<p>Managing dependencies in Formula is very easy. In the function that instantiates the <code>ActivityStore</code> for your activity, 
you can create your activity specific dependencies or Dagger components. These objects will survive configuration changes.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyApp</span> <span class="p">:</span> <span class="n">Application</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">()</span>

        <span class="k">val</span> <span class="py">appComponent</span><span class="p">:</span> <span class="n">AppComponent</span> <span class="p">=</span> <span class="p">...</span>

        <span class="n">FormulaAndroid</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">activity</span><span class="p">(</span><span class="n">MyActivity</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// This component will survive configuration changes.</span>
                <span class="k">val</span> <span class="py">activityComponent</span> <span class="p">=</span> <span class="n">appComponent</span><span class="p">.</span><span class="n">createMyActivityComponent</span><span class="p">()</span>

                <span class="n">store</span> <span class="p">{</span> <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>To inject the activity or create activity dependencies that don't survive configuration changes such as ones that need direct
activity reference, you can use <code>configureActivity</code> callback.</p>
<div class="codehilite"><pre><span></span><span class="k">val</span> <span class="py">appComponent</span><span class="p">:</span> <span class="n">AppComponent</span> <span class="p">=</span> <span class="p">...</span>

<span class="n">FormulaAndroid</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">activity</span><span class="p">(</span><span class="n">MyActivity</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// This component will survive configuration changes.</span>
        <span class="k">val</span> <span class="py">activityComponent</span> <span class="p">=</span> <span class="n">appComponent</span><span class="p">.</span><span class="n">createMyActivityComponent</span><span class="p">()</span>

        <span class="n">store</span><span class="p">(</span>
            <span class="n">configureActivity</span> <span class="p">=</span> <span class="p">{</span>
                <span class="c1">// in this callback `this` is the instance of MyActivity</span>
                <span class="c1">// so we can use it to inject dependencies</span>
                <span class="n">activityComponent</span><span class="p">.</span><span class="n">inject</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>

                <span class="c1">// Or you can use setters to provide dependencies to your activity.</span>
                <span class="c1">// This dependency object won&#39;t survive configuration changes.</span>
                <span class="k">val</span> <span class="py">dependency</span> <span class="p">=</span> <span class="n">MyActivityDependency</span><span class="p">(</span><span class="n">activity</span> <span class="p">=</span> <span class="k">this</span><span class="p">)</span>
                <span class="k">this</span><span class="p">.</span><span class="n">setDependency</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../testing/" title="Testing" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Testing
              </span>
            </div>
          </a>
        
        
          <a href="../using_android_view_model/" title="Using Android View Model" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Using Android View Model
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>